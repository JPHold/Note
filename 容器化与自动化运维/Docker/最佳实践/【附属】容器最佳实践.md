[TOC]

# 统一术语
## Container Image
是文件系统树，mount技术，是一种包装技术

## Container
由两部分组成：镜像层(可写文件系统层)和传统的linux进程，通过docker stats，可以看到pid

有的说是由镜像层和容器层，这应该说的是同一个意思


## Repository
一直有个误区，`docker pull xxx`、`docker images`，以为是镜像。其实真正的意思是资源库。通过如下可证明
![[Pasted image 20210714232057.png]]

像`docker pull xxx`，其实完整的命令还会加上Hub Register地址、Namespace、tag，是Docker Daemon帮我们完成
比如`docker pull fedora`，是`docker pull docker.io/library/fedora:latest`

## Image Layer
图层
镜像由一层层的图层组成

## Registry
注册表：dockerhub，默认是Docker.io，国内访问国外hub会很慢，所以要记得该成国内的。

Docker生态的价值来源于从注册表服务器推送、拉取Repository的能力

**对于这些注册表，采用的是隐式信任，所以自己要确定好是否可靠，免得成为肉鸡**

## Namespace
分隔存储库组的工具，docker公共hub上，通常是共享镜像的人的用户名、组名或其他名称

## Tag
用于同个Repository下，如何再构建新的镜像，一般使用版本号

# 容器类型
## 无须密切关注和管理的容器
* 应用容器

## 需要密切关注和管理的容器
* 数据库容器
 
 ## 超级特权容器
需要对容器主机进行维护，操作内核的等操作，比如lxcfs，让所有容器看到的资源是自己的资源，而不是容器主机的：重新挂载/proc
https://blog.csdn.net/qq_39376481/article/details/95347195

实践中是这么写的：
在 Atomic Host 等专用容器主机上构建容器基础设施时，系统管理员仍然需要执行管理任务。无论是与 Kubernetes 或 OpenShift 等分布式系统还是独立容器主机一起使用，超级特权容器 (SPC) 都是一个强大的工具。SPC 甚至可以执行诸如加载专用内核模块之类的事情，例如使用 systemtap。在为运行容器而构建的基础架构中，管理员很可能需要 SPC 来执行管理、监控、备份等操作。重要的是要意识到 SPC 和主机内核之间通常存在更紧密的耦合，因此管理员需要选择坚如磐石


# 镜像类型
## 基础镜像
很多人将应用镜像称为基础镜像，这是错的，只能称为中间镜像

基础镜像是指没有父层的镜像，是操作系统的副本，包含一些系统工具(yum等)。通常由开源项目(centos、debian等操作系统)和供应商(redhat)制作，来源必须足够安全，是衍生镜像的起点

## 中间镜像
以基础镜像为基础，构建出核心构建镜像、中间件镜像、语言运行时镜像(应该是指语言环境)

* 一般是独立镜像

* 其他镜像，引用这些镜像，就可以达到快速使用

## 生成器镜像
引用中间镜像，达到一个效果：快速生成应用镜像

一般是只要注入代码，就可以构建镜像并跑起来

有个nginx的生成器镜像
https://github.com/openshift/source-to-image/tree/master/examples/nginx-centos7#configuring-nginx

## 联合镜像
一个镜像包含多个软件，一次性解决多个问题，我理解的意思是不用每个软件都一个
    
## 部署者镜像
管理其他容器
    
## 容器化组件
不再是独立的容器，而是各个容器有交互，比如微服务，我理解是将拆分后的服务分别使用容器部署，但这些服务之间是有调用交互的


# 应用规划
这个章节可以学习到：
1. 编写Dockerfile的注意点
2. 如何启动应用程序
3. 考虑网络情况
4. 能够在多个环境中运行
5. **痛点的解决方案**

## 多环境运行
 ### 原子主机
 [使用Atomic Host、Ansible和Cockpit部署容器](https://linux.cn/article-7861-1.html?pr)
[Fedora](https://alt.fedoraproject.org/en/cloud/)
Cockpit，web界面管理容器
ansible，便捷启动容器

 ### openshift
也是redhat公司的paas平台
docker是将应用容器化，建立隔离的运行环境
k8s是对容器化的应用，进行部署，扩展，管理等调度
openshift是在他们基础上，管理整个生命周期

## 持久化存储
因为容器是无状态的，所以要注意数据库这类服务的数据问题。

### 数据库
* 下面两张图，阐述的是传统部署方式带来的问题，以及如何避免
传统部署方式：DB服务和存储都在主机中
容器部署方式：**如果还按照传统部署方式一样，也就是放在容器内部，那么关闭容器后，数据就不见了**

**因此容器部署方式，要挂载目录到容器主机**

![[Pasted image 20210720175304.png]]
![[Pasted image 20210720175815.png]]

#### 如何访问数据库
##### 单主机
###### 传统部署方式
1. 通过ip:port访问
2. 通过文件系统访问
	也就是数据库提供的脚本，登录到命令窗口
![[Pasted image 20210720181016.png]]

###### 容器化部署方式
客户端可以在主机，也可以是在容器中
1. 主机中的客户端通过ip:port访问
2. 容器中的客户端通过挂载的脚本访问
	依托于文件系统访问
	**挂载后，主机的客户端也可以访问，所以统一用这种方式也可以**
![[Pasted image 20210720181527.png]]

##### 多主机
##### 容器化部署方式
需要将数据库容器的端口暴露到主机网络中，而不仅仅是子网
只需要如下：
1. 在Dockerfile增加export xxxPort
比如`export 1111`
2. 容器运行时指定端口映射
`docker run -p 1111:1111`
![[Pasted image 20210720182018.png]]
	