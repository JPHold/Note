[TOC]


# 版本
```shell
docker-compose version 1.21.2, build a133471
docker-py version: 3.3.0
CPython version: 3.6.5
OpenSSL version: OpenSSL 1.0.1t  3 May 2016
```

# 在compose.yaml内编写变量引用
```yaml
web:
  image: "webapp:${TAG}"
```

**如何传入变量**
写在.env文件

执行时，默认查找当前目录的.env文件。可通过--env-file修改路径

# .env文件
* 1.28+版本，.env文件默认放置在项目目录，解决不一致问题[[Docker重点]]
* 之前版本，是默认为执行命令的工作目录，或者使用--project-directory修改为项目目录，而1.28版本是使用--env-file[[Docker重点]]

* 这里定义image变量
```yaml
version: "3.6"
services:
  web:
    image: 'webapp:${TAG}'
    build: .
    ports:
      - "5000:5000"
    volumes:
      - .:/code
    environment:
      FLASK_ENV: development
  redis:
    image: "redis:alpine"
```
`docker-compose up -d`
`docker ps -a`可以观察到image为：webapp:1.5

* 使用`docker-compos config`查看替换变量后的yaml
```yaml
services:
  redis:
    image: redis:alpine
  web:
    build:
      context: /home/docker/compose/hello
    environment:
      FLASK_ENV: development
    image: webapp:1.5
    ports:
    - published: 5000
      target: 5000
    volumes:
    - /home/docker/compose/hello:/code:rw
version: '3.6'
```

* 支持系统的环境变量
```shell
export TAG=v2.0
docker-compose config

services:
  redis:
    image: redis:alpine
  web:
    build:
      context: /home/docker/compose/hello
    environment:
      FLASK_ENV: development
    image: webapp:2.0
    ports:
    - published: 5000
      target: 5000
    volumes:
    - /home/docker/compose/hello:/code:rw
version: '3.6'
```

# 修改.env路径
**可用于区分环境，比如开发、测试、正式**

我用的是1.21.2版本，因此只能使用--project-directory

我在当前项目目录，新建env目录，并创建.env
* 默认.env
```yaml
[root@basic hello]# docker-compose config
services:
  redis:
    image: redis:alpine
  web:
    build:
      context: /home/docker/compose/hello
    environment:
      FLASK_ENV: development
    image: webapp:1.5
    ports:
    - published: 5000
      target: 5000
    volumes:
    - /home/docker/compose/hello:/code:rw
version: '3.6'
```
* 指定.env
```yaml
[root@basic hello]# docker-compose --project-directory ./env/.env config
services:
  redis:
    image: redis:alpine
  web:
    build:
      context: /home/docker/compose/hello
    environment:
      FLASK_ENV: development
    image: webapp:1.5
    ports:
    - published: 5000
      target: 5000
    volumes:
    - /home/docker/compose/hello:/code:rw
version: '3.6'
```

# 容器中设值
**在compose.yaml的web:enviroment指定**

## 直接写死
```yaml
web:
  environment:
    - DEBUG=1
```

## 系统的环境变量
```yaml
web:
  environment:
    - DEBUG
```
这里没有指定DEBUG变量的值，而是**自动从环境变量替换相同名字的变量**

## yaml中指定路径
```yaml
web:
  env_file:
    - web-variables.env
```

# 运行时设置环境变量
**与docker run -e差不多**
`docker-compose run -e VARIABLE=value`
docker-compose run -e DEBUG =1

也支持从系统的环境变量
docker-compose run -e DEBUG 

# 变量优先级
相同变量，不同方式的优先级
1. Compose file
2. Shell environment variables
3. Environment file
4. Dockerfile
5. Variable is not defined
**compose没有设置environment和env file才会在Dockerfile定义ARG或ENV**


# 使用环境变量配置compose命令行
[Compose CLI environment variables](https://docs.docker.com/compose/reference/envvars/)